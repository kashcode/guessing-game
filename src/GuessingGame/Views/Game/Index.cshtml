@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Xsrf

@functions{
    public string GetAntiXsrfRequestToken()
    {
        return Xsrf.GetAndStoreTokens(Context).RequestToken;
    }
}

@model GuessingGame.Models.Game

@{
    ViewData["Title"] = "Game";
}

<div id="app" v-cloak>
    <div class="row">
        <h3>@User.Identity.Name</h3>
    </div>
    <div class="row">
        <div class="input-group input-group-lg">
            <input type="text" class="form-control text-center numeric" maxlength="1" v-model.numeric="input[0]" required>
            <input type="text" class="form-control text-center numeric" maxlength="1" v-model.numeric="input[1]" required>
            <input type="text" class="form-control text-center numeric" maxlength="1" v-model.numeric="input[2]" required>
            <input type="text" class="form-control text-center numeric" maxlength="1" v-model.numeric="input[3]" required>
        </div>
    </div>
    <div class="text-center" style="margin-top: 16px;">
        <button v-if="guessesLeft == 1" type="button" class="btn btn-primary btn-lg" v-on:click="makeGuess">Make guess (last chance)</button>
        <button v-else type="button" class="btn btn-primary btn-lg" v-on:click="makeGuess">Make guess (tries left {{guessesLeft}})</button>
    </div>
    <div v-if="logs.length > 0">
        <h4>Previous guess: {{logs[0].input}} M:{{logs[0].matchingDigits}} P:{{logs[0].matchingDigitsPlaces}}</h4>
    </div>
    <div v-if="logs.length > 0">
        <h4>Logs:</h4>
        <ul>
            <li v-for="(log, index) in logs">
                {{ log.input }} M:{{log.matchingDigits}} P:{{log.matchingDigitsPlaces}}
            </li>
        </ul>
    </div>
</div>

@section Scripts {
    <script src="~/lib/vuejs/vue.js"></script>
    <script>
    new Vue({
        el: '#app',
        data: {
            gameUuid: "@Model.Uuid",
            input: [null, null, null, null],
            guessesLeft: 8,
            logs: []
        },
        methods: {
            makeGuess: function () {
                $self = this;

                $.ajax({
                    url: '@Url.Action("MakeGuess", "Game")',
                    type: "post",
                    headers: {
                        'X-CSRF-TOKEN': '@GetAntiXsrfRequestToken()'
                    },
                    data: {
                        gameUuid: $self.gameUuid,
                        input: $self.input
                    },
                    success: function (response) {
                        if (response.secretGuessed || response.gameOver) {
                            window.location = response.url;
                        }

                        $self.guessesLeft = response.guessesLeft;
                        $self.logs = response.logs;
                        $self.input = [null, null, null, null];
                    },
                    error: function () {
                        console.log('error');
                    }
                });
            }
        }
    });
    </script>
}